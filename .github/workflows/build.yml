name: Build Android PDF Chat APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: kivy/buildozer:latest

    steps:
      - uses: actions/checkout@v4

      - name: Create main.py
        run: |
          cat > main.py << 'EOF'
from kivy.app import App
from kivy.uix.boxlayout import BoxLayout
from kivy.uix.label import Label
from kivy.uix.textinput import TextInput
from kivy.uix.button import Button
from kivy.uix.scrollview import ScrollView
from kivy.core.window import Window
from kivy.clock import Clock
from kivy.metrics import dp
from kivy.graphics import Color, RoundedRectangle
from kivy.utils import platform
import os

if platform == 'android':
    from android.permissions import request_permissions, Permission
    from android.storage import primary_external_storage_path
    from jnius import autoclass

try:
    import PyPDF2
except ImportError:
    PyPDF2 = None

Window.clearcolor = (0.1, 0.1, 0.1, 1)  # Dark background


class MessageBubble(BoxLayout):
    """Chat message bubble with rounded corners."""
    def __init__(self, text, is_user=True, **kwargs):
        super().__init__(**kwargs)
        self.orientation = 'horizontal'
        self.size_hint_y = None
        self.padding = [dp(10), dp(5)]
        self.spacing = dp(10)

        bubble_color = (0.1, 0.4, 0.6, 1) if is_user else (0.2, 0.3, 0.4, 1)
        halign = 'right' if is_user else 'left'

        with self.canvas.before:
            Color(*bubble_color)
            self.rect = RoundedRectangle(pos=self.pos, size=self.size, radius=[dp(10)])

        self.label = Label(
            text=text,
            size_hint=(None, 1),
            width=dp(280),
            text_size=(dp(270), None),
            halign=halign,
            valign='middle',
            color=(1, 1, 1, 1),
            markup=True
        )
        self.label.bind(texture_size=self.label.setter('size'))
        self.add_widget(self.label)
        self.bind(pos=self.update_rect, size=self.update_rect)

    def update_rect(self, *args):
        self.rect.pos = self.pos
        self.rect.size = self.size


class PDFChatApp(App):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.pdf_text = ""
        self.pdf_loaded = False
        self.chunks = []  # Text chunks for searching

    def build(self):
        main = BoxLayout(orientation='vertical', padding=dp(10), spacing=dp(10))

        # Chat display area
        self.scroll = ScrollView()
        self.chat_area = BoxLayout(
            orientation='vertical',
            size_hint_y=None,
            spacing=dp(5)
        )
        self.chat_area.bind(minimum_height=self.chat_area.setter('height'))
        self.scroll.add_widget(self.chat_area)

        # Info label for PDF status
        self.info_label = Label(
            text="No PDF loaded. Tap 'Select PDF' to choose a file.",
            size_hint_y=None,
            height=dp(40),
            color=(0.8, 0.8, 0.8, 1)
        )

        # Button layout
        button_layout = BoxLayout(size_hint_y=None, height=dp(50), spacing=dp(10))

        self.select_btn = Button(
            text="Select PDF",
            size_hint_x=0.3,
            background_color=(0.2, 0.6, 1, 1)
        )
        self.select_btn.bind(on_release=self.select_pdf)

        self.input = TextInput(
            multiline=False,
            hint_text="Ask a question about the PDF...",
            background_color=(0.2, 0.2, 0.2, 1),
            foreground_color=(1, 1, 1, 1),
            disabled=not self.pdf_loaded
        )
        self.input.bind(on_text_validate=self.send_question)

        send_btn = Button(
            text="Send",
            size_hint_x=0.2,
            background_color=(0.2, 0.6, 1, 1),
            disabled=not self.pdf_loaded
        )
        send_btn.bind(on_release=self.send_question)

        button_layout.add_widget(self.select_btn)
        button_layout.add_widget(self.input)
        button_layout.add_widget(send_btn)

        main.add_widget(self.info_label)
        main.add_widget(self.scroll)
        main.add_widget(button_layout)

        # Welcome message
        self.add_message("Hello! First, select a PDF file.", is_user=False)

        # Request permissions on Android
        if platform == 'android':
            request_permissions([
                Permission.READ_EXTERNAL_STORAGE,
                Permission.WRITE_EXTERNAL_STORAGE
            ])

        return main

    def select_pdf(self, instance):
        """Select PDF file from device."""
        if platform == 'android':
            try:
                PythonActivity = autoclass('org.kivy.android.PythonActivity')
                Intent = autoclass('android.content.Intent')
                Uri = autoclass('android.net.Uri')

                intent = Intent(Intent.ACTION_GET_CONTENT)
                intent.setType("application/pdf")
                intent.addCategory(Intent.CATEGORY_OPENABLE)

                current_activity = PythonActivity.mActivity
                current_activity.startActivityForResult(
                    Intent.createChooser(intent, "Select PDF"),
                    1001
                )
                # Result will be handled in on_activity_result
            except Exception as e:
                self.add_message(f"Error: {str(e)}", is_user=False)
        else:
            # For testing on desktop
            self.pdf_text = "This is a sample PDF content. Kivy is a Python framework. Buildozer creates APK files. Android runs Java and Python."
            self.pdf_loaded = True
            self.process_text()
            self.info_label.text = "Demo PDF loaded (sample text)"
            self.input.disabled = False
            self.add_message("PDF loaded! You can now ask questions.", is_user=False)

    def process_text(self):
        """Process PDF text and split into chunks."""
        import re
        sentences = re.split(r'[.!?]+', self.pdf_text)
        self.chunks = [s.strip() for s in sentences if len(s.strip()) > 20]

        if not self.chunks:
            words = self.pdf_text.split()
            chunk_size = 50
            self.chunks = [' '.join(words[i:i+chunk_size]) for i in range(0, len(words), chunk_size)]

        self.add_message(f"PDF processed into {len(self.chunks)} sections.", is_user=False)

    def send_question(self, instance):
        if not self.pdf_loaded:
            self.add_message("Please load a PDF first.", is_user=False)
            return

        question = self.input.text.strip()
        if not question:
            return

        self.add_message(f"You: {question}", is_user=True)
        self.input.text = ""

        # Simulate typing
        Clock.schedule_once(lambda dt: self.answer_question(question), 0.8)

    def answer_question(self, question):
        """Find answer by keyword search."""
        if not self.chunks:
            self.add_message("Bot: No content to search.", is_user=False)
            return

        question_lower = question.lower()
        keywords = question_lower.split()

        # Score chunks based on keyword matches
        scored_chunks = []
        for chunk in self.chunks:
            chunk_lower = chunk.lower()
            score = sum(1 for word in keywords if word in chunk_lower and len(word) > 3)
            scored_chunks.append((score, chunk))

        scored_chunks.sort(reverse=True)

        if scored_chunks and scored_chunks[0][0] > 0:
            best_chunk = scored_chunks[0][1]
            if len(best_chunk) > 200:
                best_chunk = best_chunk[:200] + "..."
            self.add_message(f"Bot: {best_chunk}", is_user=False)
        else:
            self.add_message("Bot: I couldn't find an answer in the PDF. Try asking differently.", is_user=False)

    def add_message(self, text, is_user):
        bubble = MessageBubble(text=text, is_user=is_user)
        self.chat_area.add_widget(bubble)
        Clock.schedule_once(lambda dt: setattr(self.scroll, 'scroll_y', 0), 0.1)


if __name__ == '__main__':
    PDFChatApp().run()
EOF

      - name: Create buildozer.spec
        run: |
          cat > buildozer.spec << 'EOF'
[app]
title = PDF Chatbot
package.name = pdfchat
package.domain = org.example
source.dir = .
source.include_exts = py,png,jpg,kv,atlas
version = 0.1
requirements = python3,kivy==2.1.0,PyPDF2
orientation = portrait
fullscreen = 0

[buildozer]
log_level = 2
android.accept_sdk_license = True
android.ndk = 25b
android.sdk = 24
android.minapi = 21
android.api = 31
android.arch = arm64-v8a

# Permissions for reading files
android.permissions = android.permission.READ_EXTERNAL_STORAGE, android.permission.WRITE_EXTERNAL_STORAGE
EOF

      - name: Build APK
        run: |
          yes | buildozer android debug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: pdf-chatbot-apk
          path: bin/*.apk
