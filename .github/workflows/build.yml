name: Build Android PDF Chat APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: kivy/buildozer:latest

    steps:
      - uses: actions/checkout@v4

      - name: Create main.py
        run: |
          echo 'from kivy.app import App' > main.py
          echo 'from kivy.uix.boxlayout import BoxLayout' >> main.py
          echo 'from kivy.uix.label import Label' >> main.py
          echo 'from kivy.uix.textinput import TextInput' >> main.py
          echo 'from kivy.uix.button import Button' >> main.py
          echo 'from kivy.uix.scrollview import ScrollView' >> main.py
          echo 'from kivy.core.window import Window' >> main.py
          echo 'from kivy.clock import Clock' >> main.py
          echo 'from kivy.metrics import dp' >> main.py
          echo 'from kivy.graphics import Color, RoundedRectangle' >> main.py
          echo 'from kivy.utils import platform' >> main.py
          echo 'import os' >> main.py
          echo '' >> main.py
          echo 'if platform == "android":' >> main.py
          echo '    from android.permissions import request_permissions, Permission' >> main.py
          echo '    from android.storage import primary_external_storage_path' >> main.py
          echo '    from jnius import autoclass' >> main.py
          echo '' >> main.py
          echo 'try:' >> main.py
          echo '    import PyPDF2' >> main.py
          echo 'except ImportError:' >> main.py
          echo '    PyPDF2 = None' >> main.py
          echo '' >> main.py
          echo 'Window.clearcolor = (0.1, 0.1, 0.1, 1)' >> main.py
          echo '' >> main.py
          echo '' >> main.py
          echo 'class MessageBubble(BoxLayout):' >> main.py
          echo '    def __init__(self, text, is_user=True, **kwargs):' >> main.py
          echo '        super().__init__(**kwargs)' >> main.py
          echo '        self.orientation = "horizontal"' >> main.py
          echo '        self.size_hint_y = None' >> main.py
          echo '        self.padding = [dp(10), dp(5)]' >> main.py
          echo '        self.spacing = dp(10)' >> main.py
          echo '' >> main.py
          echo '        bubble_color = (0.1, 0.4, 0.6, 1) if is_user else (0.2, 0.3, 0.4, 1)' >> main.py
          echo '        halign = "right" if is_user else "left"' >> main.py
          echo '' >> main.py
          echo '        with self.canvas.before:' >> main.py
          echo '            Color(*bubble_color)' >> main.py
          echo '            self.rect = RoundedRectangle(pos=self.pos, size=self.size, radius=[dp(10)])' >> main.py
          echo '' >> main.py
          echo '        self.label = Label(' >> main.py
          echo '            text=text,' >> main.py
          echo '            size_hint=(None, 1),' >> main.py
          echo '            width=dp(280),' >> main.py
          echo '            text_size=(dp(270), None),' >> main.py
          echo '            halign=halign,' >> main.py
          echo '            valign="middle",' >> main.py
          echo '            color=(1, 1, 1, 1),' >> main.py
          echo '            markup=True' >> main.py
          echo '        )' >> main.py
          echo '        self.label.bind(texture_size=self.label.setter("size"))' >> main.py
          echo '        self.add_widget(self.label)' >> main.py
          echo '        self.bind(pos=self.update_rect, size=self.update_rect)' >> main.py
          echo '' >> main.py
          echo '    def update_rect(self, *args):' >> main.py
          echo '        self.rect.pos = self.pos' >> main.py
          echo '        self.rect.size = self.size' >> main.py
          echo '' >> main.py
          echo '' >> main.py
          echo 'class PDFChatApp(App):' >> main.py
          echo '    def __init__(self, **kwargs):' >> main.py
          echo '        super().__init__(**kwargs)' >> main.py
          echo '        self.pdf_text = ""' >> main.py
          echo '        self.pdf_loaded = False' >> main.py
          echo '        self.chunks = []' >> main.py
          echo '' >> main.py
          echo '    def build(self):' >> main.py
          echo '        main = BoxLayout(orientation="vertical", padding=dp(10), spacing=dp(10))' >> main.py
          echo '' >> main.py
          echo '        self.scroll = ScrollView()' >> main.py
          echo '        self.chat_area = BoxLayout(' >> main.py
          echo '            orientation="vertical",' >> main.py
          echo '            size_hint_y=None,' >> main.py
          echo '            spacing=dp(5)' >> main.py
          echo '        )' >> main.py
          echo '        self.chat_area.bind(minimum_height=self.chat_area.setter("height"))' >> main.py
          echo '        self.scroll.add_widget(self.chat_area)' >> main.py
          echo '' >> main.py
          echo '        self.info_label = Label(' >> main.py
          echo '            text="No PDF loaded. Tap \'Select PDF\' to choose a file.",' >> main.py
          echo '            size_hint_y=None,' >> main.py
          echo '            height=dp(40),' >> main.py
          echo '            color=(0.8, 0.8, 0.8, 1)' >> main.py
          echo '        )' >> main.py
          echo '' >> main.py
          echo '        button_layout = BoxLayout(size_hint_y=None, height=dp(50), spacing=dp(10))' >> main.py
          echo '' >> main.py
          echo '        self.select_btn = Button(' >> main.py
          echo '            text="Select PDF",' >> main.py
          echo '            size_hint_x=0.3,' >> main.py
          echo '            background_color=(0.2, 0.6, 1, 1)' >> main.py
          echo '        )' >> main.py
          echo '        self.select_btn.bind(on_release=self.select_pdf)' >> main.py
          echo '' >> main.py
          echo '        self.input = TextInput(' >> main.py
          echo '            multiline=False,' >> main.py
          echo '            hint_text="Ask a question about the PDF...",' >> main.py
          echo '            background_color=(0.2, 0.2, 0.2, 1),' >> main.py
          echo '            foreground_color=(1, 1, 1, 1),' >> main.py
          echo '            disabled=not self.pdf_loaded' >> main.py
          echo '        )' >> main.py
          echo '        self.input.bind(on_text_validate=self.send_question)' >> main.py
          echo '' >> main.py
          echo '        send_btn = Button(' >> main.py
          echo '            text="Send",' >> main.py
          echo '            size_hint_x=0.2,' >> main.py
          echo '            background_color=(0.2, 0.6, 1, 1),' >> main.py
          echo '            disabled=not self.pdf_loaded' >> main.py
          echo '        )' >> main.py
          echo '        send_btn.bind(on_release=self.send_question)' >> main.py
          echo '' >> main.py
          echo '        button_layout.add_widget(self.select_btn)' >> main.py
          echo '        button_layout.add_widget(self.input)' >> main.py
          echo '        button_layout.add_widget(send_btn)' >> main.py
          echo '' >> main.py
          echo '        main.add_widget(self.info_label)' >> main.py
          echo '        main.add_widget(self.scroll)' >> main.py
          echo '        main.add_widget(button_layout)' >> main.py
          echo '' >> main.py
          echo '        self.add_message("Hello! First, select a PDF file.", is_user=False)' >> main.py
          echo '' >> main.py
          echo '        if platform == "android":' >> main.py
          echo '            from android.permissions import request_permissions, Permission' >> main.py
          echo '            request_permissions([' >> main.py
          echo '                Permission.READ_EXTERNAL_STORAGE,' >> main.py
          echo '                Permission.WRITE_EXTERNAL_STORAGE' >> main.py
          echo '            ])' >> main.py
          echo '' >> main.py
          echo '        return main' >> main.py
          echo '' >> main.py
          echo '    def select_pdf(self, instance):' >> main.py
          echo '        if platform == "android":' >> main.py
          echo '            try:' >> main.py
          echo '                PythonActivity = autoclass("org.kivy.android.PythonActivity")' >> main.py
          echo '                Intent = autoclass("android.content.Intent")' >> main.py
          echo '                Uri = autoclass("android.net.Uri")' >> main.py
          echo '' >> main.py
          echo '                intent = Intent(Intent.ACTION_GET_CONTENT)' >> main.py
          echo '                intent.setType("application/pdf")' >> main.py
          echo '                intent.addCategory(Intent.CATEGORY_OPENABLE)' >> main.py
          echo '' >> main.py
          echo '                current_activity = PythonActivity.mActivity' >> main.py
          echo '                current_activity.startActivityForResult(' >> main.py
          echo '                    Intent.createChooser(intent, "Select PDF"),' >> main.py
          echo '                    1001' >> main.py
          echo '                )' >> main.py
          echo '            except Exception as e:' >> main.py
          echo '                self.add_message(f"Error: {str(e)}", is_user=False)' >> main.py
          echo '        else:' >> main.py
          echo '            self.pdf_text = "This is a sample PDF content. Kivy is a Python framework. Buildozer creates APK files. Android runs Java and Python."' >> main.py
          echo '            self.pdf_loaded = True' >> main.py
          echo '            self.process_text()' >> main.py
          echo '            self.info_label.text = "Demo PDF loaded (sample text)"' >> main.py
          echo '            self.input.disabled = False' >> main.py
          echo '            self.add_message("PDF loaded! You can now ask questions.", is_user=False)' >> main.py
          echo '' >> main.py
          echo '    def process_text(self):' >> main.py
          echo '        import re' >> main.py
          echo '        sentences = re.split(r"[.!?]+", self.pdf_text)' >> main.py
          echo '        self.chunks = [s.strip() for s in sentences if len(s.strip()) > 20]' >> main.py
          echo '' >> main.py
          echo '        if not self.chunks:' >> main.py
          echo '            words = self.pdf_text.split()' >> main.py
          echo '            chunk_size = 50' >> main.py
          echo '            self.chunks = [" ".join(words[i:i+chunk_size]) for i in range(0, len(words), chunk_size)]' >> main.py
          echo '' >> main.py
          echo '        self.add_message(f"PDF processed into {len(self.chunks)} sections.", is_user=False)' >> main.py
          echo '' >> main.py
          echo '    def send_question(self, instance):' >> main.py
          echo '        if not self.pdf_loaded:' >> main.py
          echo '            self.add_message("Please load a PDF first.", is_user=False)' >> main.py
          echo '            return' >> main.py
          echo '' >> main.py
          echo '        question = self.input.text.strip()' >> main.py
          echo '        if not question:' >> main.py
          echo '            return' >> main.py
          echo '' >> main.py
          echo '        self.add_message(f"You: {question}", is_user=True)' >> main.py
          echo '        self.input.text = ""' >> main.py
          echo '        Clock.schedule_once(lambda dt: self.answer_question(question), 0.8)' >> main.py
          echo '' >> main.py
          echo '    def answer_question(self, question):' >> main.py
          echo '        if not self.chunks:' >> main.py
          echo '            self.add_message("Bot: No content to search.", is_user=False)' >> main.py
          echo '            return' >> main.py
          echo '' >> main.py
          echo '        question_lower = question.lower()' >> main.py
          echo '        keywords = question_lower.split()' >> main.py
          echo '' >> main.py
          echo '        scored_chunks = []' >> main.py
          echo '        for chunk in self.chunks:' >> main.py
          echo '            chunk_lower = chunk.lower()' >> main.py
          echo '            score = sum(1 for word in keywords if word in chunk_lower and len(word) > 3)' >> main.py
          echo '            scored_chunks.append((score, chunk))' >> main.py
          echo '' >> main.py
          echo '        scored_chunks.sort(reverse=True)' >> main.py
          echo '' >> main.py
          echo '        if scored_chunks and scored_chunks[0][0] > 0:' >> main.py
          echo '            best_chunk = scored_chunks[0][1]' >> main.py
          echo '            if len(best_chunk) > 200:' >> main.py
          echo '                best_chunk = best_chunk[:200] + "..."' >> main.py
          echo '            self.add_message(f"Bot: {best_chunk}", is_user=False)' >> main.py
          echo '        else:' >> main.py
          echo '            self.add_message("Bot: I couldn\'t find an answer in the PDF. Try asking differently.", is_user=False)' >> main.py
          echo '' >> main.py
          echo '    def add_message(self, text, is_user):' >> main.py
          echo '        bubble = MessageBubble(text=text, is_user=is_user)' >> main.py
          echo '        self.chat_area.add_widget(bubble)' >> main.py
          echo '        Clock.schedule_once(lambda dt: setattr(self.scroll, "scroll_y", 0), 0.1)' >> main.py
          echo '' >> main.py
          echo 'if __name__ == "__main__":' >> main.py
          echo '    PDFChatApp().run()' >> main.py

      - name: Create buildozer.spec
        run: |
          echo '[app]' > buildozer.spec
          echo 'title = PDF Chatbot' >> buildozer.spec
          echo 'package.name = pdfchat' >> buildozer.spec
          echo 'package.domain = org.example' >> buildozer.spec
          echo 'source.dir = .' >> buildozer.spec
          echo 'source.include_exts = py,png,jpg,kv,atlas' >> buildozer.spec
          echo 'version = 0.1' >> buildozer.spec
          echo 'requirements = python3,kivy==2.1.0,PyPDF2' >> buildozer.spec
          echo 'orientation = portrait' >> buildozer.spec
          echo 'fullscreen = 0' >> buildozer.spec
          echo '' >> buildozer.spec
          echo '[buildozer]' >> buildozer.spec
          echo 'log_level = 2' >> buildozer.spec
          echo 'android.accept_sdk_license = True' >> buildozer.spec
          echo 'android.ndk = 25b' >> buildozer.spec
          echo 'android.sdk = 24' >> buildozer.spec
          echo 'android.minapi = 21' >> buildozer.spec
          echo 'android.api = 31' >> buildozer.spec
          echo 'android.arch = arm64-v8a' >> buildozer.spec
          echo '' >> buildozer.spec
          echo '# Permissions for reading files' >> buildozer.spec
          echo 'android.permissions = android.permission.READ_EXTERNAL_STORAGE, android.permission.WRITE_EXTERNAL_STORAGE' >> buildozer.spec

      - name: Build APK
        run: |
          yes | buildozer android debug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: pdf-chatbot-apk
          path: bin/*.apk
